<div class="flex gap-2">
  <p-button routerLink="/menu-planning">Menüplanung</p-button>
  <p-button routerLink="/menu-planning/my-menus">Meine Menüs</p-button>
  <p-button routerLink="/menu-planning/shopping-list">Einkaufszettel</p-button>
  <p-button>Angebotsliste</p-button>
</div>
<p-confirmDialog></p-confirmDialog>
<div class="container">
  <p-toast></p-toast>
  <div class="menu-plan-form">
    <div>
      <br><br>
      <p-button (onClick)="showDialog()" label="Rezept Hinzufügen" />
      <div class="menu-plan-list rbm_scrollbar" (wheel)="onWheel($event)">
        <div *ngIf="menuPlan.length === 0" class="recipe-item placeholder">
          <p>Keine Rezepte hinzugefügt</p>
        </div>
        <div *ngFor="let recipe of menuPlan" class="recipe-item">
          <img [src]="recipe.recipeImage ? recipe.recipeImage : 'assets/default-image.png'"
            alt="{{ recipe.recipeName }}" class="recipe-image">
          <div class="recipe-name">
            <p>{{ recipe.recipeName }}</p>
          </div>
          <p-button class="remove-button rbm-standard-pbtn-round"
            (click)="removeRecipeFromMenuPlan(recipe)">-</p-button>
        </div>
      </div>

    </div>
    <div class="validation-message"
      *ngIf="menuPlanForm.hasError('atLeastOneRecipe') && (menuPlanForm.dirty || menuPlanForm.touched)">
      Es muss mindestens ein Rezept hinzugefügt werden.
    </div>
    <div class="rbm-flex-row rbm-space-between rbm-gap-xl">
      <form [formGroup]="menuPlanForm" class="menu-plan-form rbm-columns-2 rbm-width-40">
        <div class="date-config">
          <div class="form-field">
            <label for="nachsteAusfuhrung">Nächste Ausführung<span class="mandatory">*</span></label>
            <p-dropdown id="nachsteAusfuhrung" formControlName="nachsteAusfuhrung"
              [options]="nextExecutionOptions"></p-dropdown>
            <div class="validation-message"
              *ngIf="menuPlanForm.get('nachsteAusfuhrung')?.hasError('required') && (menuPlanForm.get('nachsteAusfuhrung')?.touched || menuPlanForm.get('nachsteAusfuhrung')?.dirty)">
              Nächste Ausführung ist erforderlich.
            </div>
          </div>

          <div class="form-field">
            <label for="wochentag">Wochentag<span class="mandatory">*</span></label>
            <p-dropdown id="wochentag" formControlName="wochentag" [options]="weekDays"></p-dropdown>
            <div class="validation-message"
              *ngIf="menuPlanForm.get('wochentag')?.hasError('required') && (menuPlanForm.get('wochentag')?.touched || menuPlanForm.get('wochentag')?.dirty)">
              Wochentag ist erforderlich.
            </div>
          </div>

          <div class="form-field">
            <label for="wiederholung">Wiederholung<span class="mandatory">*</span></label>
            <p-dropdown id="wiederholung" formControlName="wiederholung" [options]="repeatOptions"></p-dropdown>
            <div class="validation-message"
              *ngIf="menuPlanForm.get('wiederholung')?.hasError('required') && (menuPlanForm.get('wiederholung')?.touched || menuPlanForm.get('wiederholung')?.dirty)">
              Wiederholung ist erforderlich.
            </div>
          </div>
        </div>

        <div class="form-field">
          <label for="name">Name<span class="mandatory">*</span></label>
          <input id="name" type="text" formControlName="name" pInputText placeholder="Name" class="input-text" />
          <div class="validation-message"
            *ngIf="menuPlanForm.get('name')?.hasError('required') && (menuPlanForm.get('name')?.touched || menuPlanForm.get('name')?.dirty)">
            Name ist erforderlich.
          </div>
        </div>

        <div class="form-field">
          <label for="ort">Ort<span class="mandatory">*</span></label>
          <input id="ort" type="text" formControlName="ort" pInputText placeholder="Ort" class="input-text" />
          <div class="validation-message"
            *ngIf="menuPlanForm.get('ort')?.hasError('required') && (menuPlanForm.get('ort')?.touched || menuPlanForm.get('ort')?.dirty)">
            Ort ist erforderlich.
          </div>
        </div>

        <div class="form-field description-field">
          <label for="description">Beschreibung</label>
          <textarea id="description" formControlName="description" pInputTextarea placeholder="Beschreibung"
            class="textarea"></textarea>
          <div class="validation-message"
            *ngIf="menuPlanForm.get('description')?.hasError('optionalMinLength') && (menuPlanForm.get('description')?.touched || menuPlanForm.get('description')?.dirty)">
            Die Beschreibung muss mindestens 1 Zeichen lang sein, falls sie ausgefüllt ist.
          </div>
        </div>

        <div class="form-field">
          <label for="portions">Portionen<span class="mandatory">*</span></label>
          <div class="input-wrapper">
            <input id="portions" type="number" formControlName="portions" pInputText placeholder="0"
              class="input-number" min="0" />
            <span class="suffix">Personen</span>
          </div>
          <div class="validation-message"
            *ngIf="menuPlanForm.get('portions')?.hasError('min') && (menuPlanForm.get('portions')?.touched || menuPlanForm.get('portions')?.dirty)">
            Portionen muss mindestens 0 sein.
          </div>
        </div>

        <div class="form-field">
          <label for="portionsVegetarisch">Vegetarisch<span class="mandatory">*</span></label>
          <div class="input-wrapper">
            <input id="portionsVegetarisch" type="number" formControlName="portionsVegetarisch" pInputText
              placeholder="0" class="input-number" min="0" />
            <span class="suffix">Personen</span>
          </div>
          <div class="validation-message"
            *ngIf="menuPlanForm.get('portionsVegetarisch')?.hasError('min') && (menuPlanForm.get('portionsVegetarisch')?.touched || menuPlanForm.get('portionsVegetarisch')?.dirty)">
            Vegetarische Portionen müssen mindestens 0 sein.
          </div>
        </div>

        <div class="form-field">
          <label for="portionsVegan">Vegan<span class="mandatory">*</span></label>
          <div class="input-wrapper">
            <input id="portionsVegan" type="number" formControlName="portionsVegan" pInputText placeholder="0"
              class="input-number" min="0" />
            <span class="suffix">Personen</span>
          </div>
          <div class="validation-message"
            *ngIf="menuPlanForm.get('portionsVegan')?.hasError('min') && (menuPlanForm.get('portionsVegan')?.touched || menuPlanForm.get('portionsVegan')?.dirty)">
            Vegane Portionen müssen mindestens 0 sein.
          </div>
        </div>

        <!-- Form-level error message for at least one portion -->
        <div class="validation-message"
          *ngIf="menuPlanForm.hasError('atLeastOnePortion') && 
             (menuPlanForm.get('portions')?.touched || menuPlanForm.get('portionsVegetarisch')?.touched || menuPlanForm.get('portionsVegan')?.touched)">
          Mindestens eine der Portionen muss größer als 0 sein.
        </div>

        <div class="form-field">
          <p-button (click)="saveMenuPlan()" [disabled]="menuPlanForm.invalid || loading"
            [pTooltip]="menuPlanForm.invalid ? 'Bitte korrigieren Sie die ungültigen Felder, um fortzufahren.' : ''"
            tooltipPosition="top" class="save-button">
            Speichern
          </p-button>
        </div>
      </form>

      <div *ngIf="!calendarLoaded" class="text-center rbm-width-60">
        <p-progressSpinner></p-progressSpinner>
      </div>
      <full-calendar *ngIf="calendarLoaded" #calendar [options]="calendarOptions"
        class="text-center rbm-full-width"></full-calendar>
      <p-dialog [(visible)]="displayEventDialog" modal="modal" header="Event Details">
        <div *ngIf="selectedEvent">
          <h3>{{ selectedEvent.title }}</h3>
          <div class="dialog-content">
            <p><strong>Beschreibung:</strong> {{ selectedEvent.extendedProps.description }}</p>
            <p><strong>Ort:</strong> {{ selectedEvent.extendedProps.location }}</p>
            <p><strong>Portionen:</strong> {{ selectedEvent.extendedProps.portions }}</p>
            <p><strong>Vegetarische Portionen:</strong> {{ selectedEvent.extendedProps.portionsVegetarisch }}</p>
            <p><strong>Vegane Portionen:</strong> {{ selectedEvent.extendedProps.portionsVegan }}</p>
            <p><strong>Wiederholung:</strong> {{ selectedEvent.extendedProps.repeatFrequency }}</p>
          </div>
          <div class="dialog-actions">
            <p-button label="Dieses Event löschen" icon="pi pi-trash" class="p-button-danger"
              (click)="deleteSingleEvent(selectedEvent)"></p-button>
            <p-button label="Alle Events löschen" icon="pi pi-trash" class="p-button-danger"
              (click)="deleteAllEvents(selectedEvent.extendedProps.menuId)"></p-button>
          </div>
        </div>
      </p-dialog>
    </div>

  </div>

  <p-dialog header="Weitere Rezepte" [modal]="true" [(visible)]="visible" [style]="{ width: '50rem', height: '100%' }"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" class="recipe-list-all">
    <div class="search-bar">
      <input type="text" pInputText placeholder="Suche nach Rezept" [(ngModel)]="searchQuery"
        (input)="filterRecipes()" />
    </div>
    <div class="recipe-list-add" #recipeList>
      <div *ngIf="!recipesLoaded" class="text-center">
        <p-progressSpinner></p-progressSpinner>
      </div>
      <div *ngFor="let recipe of filteredRecipes" class="recipe-item">
        <img [src]="recipe.recipeImage ? recipe.recipeImage : 'assets/default-image.png'" alt="{{ recipe.recipeName }}"
          class="recipe-image">
        <div class="recipe-name">{{ recipe.recipeName }}</div>
        <p-button class="add-button rbm-standard-pbtn-round" (click)="addRecipeToMenuPlan(recipe)">+</p-button>
      </div>
    </div>

  </p-dialog>