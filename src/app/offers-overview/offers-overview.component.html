<div class="rbm-site-toolbar" style="margin-bottom: 1rem;">
    <p-button class="first" routerLink="/menu-planning" label="Menüplanung"></p-button>
    <p-button routerLink="/menu-planning/my-menus" label="Meine Menüs"></p-button>
    <p-button routerLink="/menu-planning/shopping-list" label="Einkaufszettel"></p-button>
    <p-button routerLink="/offers-overview" class="last" label="Angebotsliste"></p-button>
</div>

<div class="actions" style="display: flex; gap: 1rem; margin-bottom: 1rem;" *ngIf="!loading">
    <button pButton label="Neu Suchen" (click)="clearCacheAndReload()"></button>
    <button pButton label="Ansicht ändern" (click)="toggleView()"></button>
</div>

<p-progressSpinner *ngIf="loading"></p-progressSpinner>

<div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;" *ngIf="!loading">
    <span>Radius:</span>
    <p-slider [(ngModel)]="range" [min]="0" [max]="1000" [step]="1" class="slider"></p-slider>
    <span>{{ range }} km</span>
</div>

<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;" *ngIf="!loading">
    <span>Suche:</span>
    <input pInputText type="text" [(ngModel)]="searchTerm" (input)="onSearchTermChange()"
        placeholder="Nach Unternehmen oder Produkt..." style="flex:1" />
</div>

<p-card header="Gefundene Angebote" class="offers-card" *ngIf="!loading">
    <!-- Gruppierte Ansicht -->
    <ng-container *ngIf="viewGrouped">
        <p-accordion>
            <ng-container *ngFor="let group of groupedOffers">
                <p-accordionTab header="{{ group.companyName }}">
                    <p-accordion>
                        <ng-container *ngFor="let offer of group.offers">
                            <p-accordionTab header="{{ getLocalizedLabel(offer?.ontoFoodType?.label) }}">

                                <div class="mb-2">
                                    <p-button *ngIf="offer?.offerDetails?.pricePerUnit" label="Kaufabsicht erstellen"
                                        (onClick)="openRequestDialog(offer, 'purchaseIntent')">
                                    </p-button>

                                    <p-button *ngIf="!offer?.offerDetails?.pricePerUnit" label="Preisanfrage erstellen"
                                        (onClick)="openRequestDialog(offer, 'priceRequest')">
                                    </p-button>
                                </div>

                                <p-panel header="Unternehmensdetails"
                                    *ngIf="offer?.company || offer?.address || offer?.roles">
                                    <p *ngIf="offer?.company?.label"><strong>Unternehmens-Label:</strong> {{
                                        offer?.company?.label }}</p>
                                    <p *ngIf="offer?.company?.verified !== undefined"><strong>Verifiziert:</strong> {{
                                        offer?.company?.verified ? 'Ja' : 'Nein' }}</p>
                                    <p *ngIf="offer?.address?.city"><strong>Adresse:</strong> {{ offer?.address?.city }}
                                    </p>
                                    <p *ngIf="offer?.roles?.length"><strong>Rollen:</strong> {{ offer?.roles?.join(', ')
                                        }}</p>
                                </p-panel>

                                <p-panel header="Produktdetails" *ngIf="offer?.product">
                                    <p *ngIf="offer?.product?.dateStart"><strong>Startdatum:</strong> {{
                                        offer?.product?.dateStart }}</p>
                                    <p *ngIf="offer?.product?.dateEnd"><strong>Enddatum:</strong> {{
                                        offer?.product?.dateEnd }}</p>
                                    <p *ngIf="offer?.product?.totalAmount"><strong>Gesamtmenge:</strong> {{
                                        offer?.product?.totalAmount }} {{ offer?.product?.unit }}</p>
                                    <p *ngIf="offer?.product?.isPermanent !== undefined"><strong>Dauerhaft:</strong> {{
                                        offer?.product?.isPermanent ? 'Ja' : 'Nein' }}</p>
                                </p-panel>

                                <p-panel header="Angebotsdetails" *ngIf="offer?.offerDetails">
                                    <p *ngIf="offer?.offerDetails?.productTitle"><strong>Produktname:</strong> {{
                                        offer?.offerDetails?.productTitle }}</p>
                                    <p *ngIf="offer?.offerDetails?.brandName"><strong>Markenname:</strong> {{
                                        offer?.offerDetails?.brandName }}</p>
                                    <p *ngIf="offer?.offerDetails?.description"><strong>Beschreibung:</strong> {{
                                        offer?.offerDetails?.description }}</p>
                                    <p *ngIf="offer?.offerDetails?.minAmount?.amount"><strong>Mindestmenge:</strong> {{
                                        offer?.offerDetails?.minAmount?.amount }} {{
                                        offer?.offerDetails?.minAmount?.unit }}</p>
                                    <p *ngIf="offer?.offerDetails?.pricePerUnit"><strong>Preis pro Einheit:</strong> €{{
                                        offer?.offerDetails?.pricePerUnit }}</p>

                                    <div *ngIf="offer?.offerDetails?.levelsOfProcessing?.length">
                                        <strong>Verarbeitungen:</strong>
                                        <ul>
                                            <li *ngFor="let processing of offer?.offerDetails?.levelsOfProcessing">
                                                <p>{{ processing?.label }}</p>
                                            </li>
                                        </ul>
                                    </div>
                                </p-panel>

                                <p-panel header="Staffelpreise" *ngIf="offer?.offerDetails?.graduatedPrices?.length">
                                    <ul>
                                        <li *ngFor="let price of offer?.offerDetails?.graduatedPrices">
                                            <p>Menge: {{ price?.amount }} - Preis: €{{ price?.price }}</p>
                                        </li>
                                    </ul>
                                </p-panel>

                                <p-panel header="Behälter" *ngIf="offer?.offerDetails?.containers?.length">
                                    <ul>
                                        <li *ngFor="let container of offer?.offerDetails?.containers">
                                            <p *ngIf="container?.amount"><strong>Menge:</strong> {{ container?.amount }}
                                                {{ container?.unit }}</p>
                                            <p *ngIf="container?.returnable !== undefined">
                                                <strong>Rückgabepfand:</strong> {{ container?.returnable ? 'Ja' : 'Nein'
                                                }}</p>
                                        </li>
                                    </ul>
                                </p-panel>

                                <p-panel header="Produkteigenschaften, Gewicht und Kaliber"
                                    *ngIf="offer?.offerDetails?.productTraits?.length || offer?.offerDetails?.weight || offer?.offerDetails?.caliber">
                                    <h4 *ngIf="offer?.offerDetails?.productTraits?.length">Produkteigenschaften</h4>
                                    <ul *ngIf="offer?.offerDetails?.productTraits?.length">
                                        <li *ngFor="let trait of offer?.offerDetails?.productTraits">
                                            <p>{{ trait?.trait }}: {{ trait?.description }}</p>
                                        </li>
                                    </ul>

                                    <h4 *ngIf="offer?.offerDetails?.weight">Gewicht</h4>
                                    <p *ngIf="offer?.offerDetails?.weight?.min">Min: {{ offer?.offerDetails?.weight?.min
                                        }} {{ offer?.offerDetails?.weight?.unit }}</p>
                                    <p *ngIf="offer?.offerDetails?.weight?.max">Max: {{ offer?.offerDetails?.weight?.max
                                        }} {{ offer?.offerDetails?.weight?.unit }}</p>

                                    <h4 *ngIf="offer?.offerDetails?.caliber">Kaliber</h4>
                                    <p *ngIf="offer?.offerDetails?.caliber?.min">Min: {{
                                        offer?.offerDetails?.caliber?.min }} {{ offer?.offerDetails?.caliber?.unit }}
                                    </p>
                                    <p *ngIf="offer?.offerDetails?.caliber?.max">Max: {{
                                        offer?.offerDetails?.caliber?.max }} {{ offer?.offerDetails?.caliber?.unit }}
                                    </p>
                                </p-panel>

                                <p-panel header="OntoFood Typ" *ngIf="offer?.ontoFoodType">
                                    <p *ngIf="offer?.ontoFoodType?.label"><strong>Label:</strong> {{
                                        offer?.ontoFoodType?.label }}</p>
                                    <p *ngIf="offer?.ontoFoodType?.label"><strong>Übersetzt:</strong> {{
                                        getLocalizedLabel(offer?.ontoFoodType?.label) }}</p>
                                    <p *ngIf="offer?.ontoFoodType?.company !== undefined"><strong>Firma:</strong> {{
                                        offer?.ontoFoodType?.company ? 'Ja' : 'Nein' }}</p>
                                    <p *ngIf="offer?.ontoFoodType?.market !== undefined"><strong>Im Markt
                                            verfügbar:</strong> {{ offer?.ontoFoodType?.market ? 'Ja' : 'Nein' }}</p>

                                    <div *ngIf="offer?.ontoFoodType?.links?.supercategories?.length">
                                        <strong>Überkategorien:</strong>
                                        <ul>
                                            <li *ngFor="let category of offer?.ontoFoodType?.links?.supercategories">
                                                <a href="{{ category }}" target="_blank">Überkategorie anzeigen</a>
                                            </li>
                                        </ul>
                                    </div>
                                </p-panel>

                                <p-panel header="Links" *ngIf="offer?.links">
                                    <p *ngIf="offer?.links?.self"><strong>Selbst:</strong> <a
                                            href="{{ offer?.links?.self }}" target="_blank">Angebot anzeigen</a></p>
                                    <p *ngIf="offer?.links?.company"><strong>Firma:</strong> <a
                                            href="{{ offer?.links?.company }}" target="_blank">Firma anzeigen</a></p>
                                    <p *ngIf="offer?.links?.category"><strong>Kategorie:</strong> <a
                                            href="{{ offer?.links?.category }}" target="_blank">Kategorie anzeigen</a>
                                    </p>
                                    <p *ngIf="offer?.links?.contact"><strong>Kontakt:</strong> <a
                                            href="{{ offer?.links?.contact }}" target="_blank">Kontakt</a></p>
                                </p-panel>

                            </p-accordionTab>
                        </ng-container>
                    </p-accordion>
                </p-accordionTab>
            </ng-container>
        </p-accordion>
    </ng-container>

    <!-- Nicht gruppierte Ansicht -->
    <ng-container *ngIf="!viewGrouped">
        <p-accordion *ngIf="displayedOffers && displayedOffers.length > 0">
            <ng-container *ngFor="let offer of displayedOffers">
                <p-accordionTab header="{{ offer?.company?.name }} {{ getLocalizedLabel(offer?.ontoFoodType?.label) }}">

                    <div class="mb-2">
                        <p-button *ngIf="offer?.offerDetails?.pricePerUnit" label="Kaufabsicht erstellen"
                            (onClick)="openRequestDialog(offer, 'purchaseIntent')">
                        </p-button>

                        <p-button *ngIf="!offer?.offerDetails?.pricePerUnit" label="Preisanfrage erstellen"
                            (onClick)="openRequestDialog(offer, 'priceRequest')">
                        </p-button>
                    </div>

                    <p-panel header="Unternehmensdetails" *ngIf="offer?.company || offer?.address || offer?.roles">
                        <p *ngIf="offer?.company?.label"><strong>Unternehmens-Label:</strong> {{ offer?.company?.label
                            }}</p>
                        <p *ngIf="offer?.company?.verified !== undefined"><strong>Verifiziert:</strong> {{
                            offer?.company?.verified ? 'Ja' : 'Nein' }}</p>
                        <p *ngIf="offer?.address?.city"><strong>Adresse:</strong> {{ offer?.address?.city }}</p>
                        <p *ngIf="offer?.roles?.length"><strong>Rollen:</strong> {{ offer?.roles?.join(', ') }}</p>
                    </p-panel>

                    <p-panel header="Produktdetails" *ngIf="offer?.product">
                        <p *ngIf="offer?.product?.dateStart"><strong>Startdatum:</strong> {{ offer?.product?.dateStart
                            }}</p>
                        <p *ngIf="offer?.product?.dateEnd"><strong>Enddatum:</strong> {{ offer?.product?.dateEnd }}</p>
                        <p *ngIf="offer?.product?.totalAmount"><strong>Gesamtmenge:</strong> {{
                            offer?.product?.totalAmount }} {{ offer?.product?.unit }}</p>
                        <p *ngIf="offer?.product?.isPermanent !== undefined"><strong>Dauerhaft:</strong> {{
                            offer?.product?.isPermanent ? 'Ja' : 'Nein' }}</p>
                    </p-panel>

                    <p-panel header="Angebotsdetails" *ngIf="offer?.offerDetails">
                        <p *ngIf="offer?.offerDetails?.productTitle"><strong>Produktname:</strong> {{
                            offer?.offerDetails?.productTitle }}</p>
                        <p *ngIf="offer?.offerDetails?.brandName"><strong>Markenname:</strong> {{
                            offer?.offerDetails?.brandName }}</p>
                        <p *ngIf="offer?.offerDetails?.description"><strong>Beschreibung:</strong> {{
                            offer?.offerDetails?.description }}</p>
                        <p *ngIf="offer?.offerDetails?.minAmount?.amount"><strong>Mindestmenge:</strong> {{
                            offer?.offerDetails?.minAmount?.amount }} {{ offer?.offerDetails?.minAmount?.unit }}</p>
                        <p *ngIf="offer?.offerDetails?.pricePerUnit"><strong>Preis pro Einheit:</strong> €{{
                            offer?.offerDetails?.pricePerUnit }}</p>

                        <div *ngIf="offer?.offerDetails?.levelsOfProcessing?.length">
                            <strong>Verarbeitungen:</strong>
                            <ul>
                                <li *ngFor="let processing of offer?.offerDetails?.levelsOfProcessing">
                                    <p>{{ processing?.label }}</p>
                                </li>
                            </ul>
                        </div>
                    </p-panel>

                    <p-panel header="Staffelpreise" *ngIf="offer?.offerDetails?.graduatedPrices?.length">
                        <ul>
                            <li *ngFor="let price of offer?.offerDetails?.graduatedPrices">
                                <p>Menge: {{ price?.amount }} - Preis: €{{ price?.price }}</p>
                            </li>
                        </ul>
                    </p-panel>

                    <p-panel header="Behälter" *ngIf="offer?.offerDetails?.containers?.length">
                        <ul>
                            <li *ngFor="let container of offer?.offerDetails?.containers">
                                <p *ngIf="container?.amount"><strong>Menge:</strong> {{ container?.amount }} {{
                                    container?.unit }}</p>
                                <p *ngIf="container?.returnable !== undefined"><strong>Rückgabepfand:</strong> {{
                                    container?.returnable ? 'Ja' : 'Nein' }}</p>
                            </li>
                        </ul>
                    </p-panel>

                    <p-panel header="Produkteigenschaften, Gewicht und Kaliber"
                        *ngIf="offer?.offerDetails?.productTraits?.length || offer?.offerDetails?.weight || offer?.offerDetails?.caliber">
                        <h4 *ngIf="offer?.offerDetails?.productTraits?.length">Produkteigenschaften</h4>
                        <ul *ngIf="offer?.offerDetails?.productTraits?.length">
                            <li *ngFor="let trait of offer?.offerDetails?.productTraits">
                                <p>{{ trait?.trait }}: {{ trait?.description }}</p>
                            </li>
                        </ul>

                        <h4 *ngIf="offer?.offerDetails?.weight">Gewicht</h4>
                        <p *ngIf="offer?.offerDetails?.weight?.min">Min: {{ offer?.offerDetails?.weight?.min }} {{
                            offer?.offerDetails?.weight?.unit }}</p>
                        <p *ngIf="offer?.offerDetails?.weight?.max">Max: {{ offer?.offerDetails?.weight?.max }} {{
                            offer?.offerDetails?.weight?.unit }}</p>

                        <h4 *ngIf="offer?.offerDetails?.caliber">Kaliber</h4>
                        <p *ngIf="offer?.offerDetails?.caliber?.min">Min: {{ offer?.offerDetails?.caliber?.min }} {{
                            offer?.offerDetails?.caliber?.unit }}</p>
                        <p *ngIf="offer?.offerDetails?.caliber?.max">Max: {{ offer?.offerDetails?.caliber?.max }} {{
                            offer?.offerDetails?.caliber?.unit }}</p>
                    </p-panel>

                    <p-panel header="OntoFood Typ" *ngIf="offer?.ontoFoodType">
                        <p *ngIf="offer?.ontoFoodType?.label"><strong>Label:</strong> {{ offer?.ontoFoodType?.label }}
                        </p>
                        <p *ngIf="offer?.ontoFoodType?.label"><strong>Übersetzt:</strong> {{
                            getLocalizedLabel(offer?.ontoFoodType?.label) }}</p>
                        <p *ngIf="offer?.ontoFoodType?.company !== undefined"><strong>Firma:</strong> {{
                            offer?.ontoFoodType?.company ? 'Ja' : 'Nein' }}</p>
                        <p *ngIf="offer?.ontoFoodType?.market !== undefined"><strong>Im Markt verfügbar:</strong> {{
                            offer?.ontoFoodType?.market ? 'Ja' : 'Nein' }}</p>

                        <div *ngIf="offer?.ontoFoodType?.links?.supercategories?.length">
                            <strong>Überkategorien:</strong>
                            <ul>
                                <li *ngFor="let category of offer?.ontoFoodType?.links?.supercategories">
                                    <a href="{{ category }}" target="_blank">Überkategorie anzeigen</a>
                                </li>
                            </ul>
                        </div>
                    </p-panel>

                    <p-panel header="Links" *ngIf="offer?.links">
                        <p *ngIf="offer?.links?.self"><strong>Selbst:</strong> <a href="{{ offer?.links?.self }}"
                                target="_blank">Angebot anzeigen</a></p>
                        <p *ngIf="offer?.links?.company"><strong>Firma:</strong> <a href="{{ offer?.links?.company }}"
                                target="_blank">Firma anzeigen</a></p>
                        <p *ngIf="offer?.links?.category"><strong>Kategorie:</strong> <a
                                href="{{ offer?.links?.category }}" target="_blank">Kategorie anzeigen</a></p>
                        <p *ngIf="offer?.links?.contact"><strong>Kontakt:</strong> <a href="{{ offer?.links?.contact }}"
                                target="_blank">Kontakt</a></p>
                    </p-panel>
                </p-accordionTab>
            </ng-container>
        </p-accordion>
        <p-paginator [totalRecords]="filteredOffers.length" [rows]="rows" (onPageChange)="onPageChange($event)"
            [rowsPerPageOptions]="[5,10,20]" styleClass="mt-3">
        </p-paginator>
    </ng-container>
</p-card>

<p-toast></p-toast>

<p-dialog [(visible)]="showRequestDialog" header="Anfrage Details hinzufügen" [modal]="true" [closable]="false">
    <div class="p-fluid">
        <div class="p-field">
            <label for="deliveryDate">Lieferdatum</label>
            <input type="date" id="deliveryDate" [(ngModel)]="requestData.deliveryDate" pInputText />
        </div>
        <div class="p-field">
            <label for="message">Nachricht</label>
            <textarea id="message" rows="3" [(ngModel)]="requestData.message" pInputTextarea></textarea>
        </div>
        <div class="p-field">
            <label for="totalAmount">Gesamtmenge</label>
            <input type="number" id="totalAmount" [(ngModel)]="requestData.totalAmount"
                [min]="selectedOffer?.offerDetails?.minAmount?.amount || 0"
                [max]="selectedOffer?.offerDetails?.totalAmount || 0" [step]="0.01" pInputText
                (keypress)="preventInvalidChars($event)" />
            <p
                *ngIf="selectedOffer?.offerDetails?.totalAmount?.amount && selectedOffer?.offerDetails?.totalAmount?.unit">
                Verfügbare Menge: {{ selectedOffer?.offerDetails?.totalAmount?.amount }}
                {{ selectedOffer?.offerDetails?.totalAmount?.unit }}
            </p>
            <p *ngIf="selectedOffer?.offerDetails?.minAmount?.amount && selectedOffer?.offerDetails?.minAmount?.unit">
                Mindestmenge: {{ selectedOffer?.offerDetails?.minAmount?.amount }}
                {{ selectedOffer?.offerDetails?.minAmount?.unit }}
            </p>
        </div>
        <div class="p-field">
            <label for="pricePerUnit">Preis pro Einheit:</label>
            <p>{{ requestData.pricePerUnit !== 'N/A' ? '€' + requestData.pricePerUnit : 'Auf Anfrage' }}</p>
        </div>
    </div>
    <p-footer>
        <button type="button" pButton icon="pi pi-times" label="Abbrechen" (click)="cancelRequest()"></button>
        <button type="button" pButton icon="pi pi-check" label="Senden" (click)="submitRequest()"></button>
    </p-footer>
</p-dialog>