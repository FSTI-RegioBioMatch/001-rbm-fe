<div class="shopping-list-details p-m-3 p-shadow-3 p-p-4">
    <h1>Shopping List and Offers</h1>

    <div class="actions">
        <button pButton label="Clear Cache & Reload Offers" (click)="clearCacheAndReload()"></button>
    </div>
    
    <p-progressSpinner *ngIf="loading"></p-progressSpinner>
    <p-confirmDialog></p-confirmDialog>

    <p-slider [(ngModel)]="range" [min]="0" [max]="250" [step]="1"></p-slider>
    <p>Selected Range: {{ range }} km</p>
    
    <div *ngIf="!loading && shoppingList" class="p-grid">
        <div class="rbm-flex-row">
        <div class="p-col-6">
            <p-card header="{{ shoppingList?.name }}"
                subheader="Date Created: {{ shoppingList?.createdAt | date:'shortDate' }}">
                <h3>Ingredients</h3>
                <p-accordion>
                    <ng-container *ngFor="let ingredientName of ingredientNames">
                      <p-accordionTab header="{{ getLocalizedLabel(ingredientName) }}">
                        <!-- Display Total Amounts per Unit -->
                        <div *ngFor="let item of getTotalAmountsPerUnitArray(ingredientName)">
                          <p>
                            <strong>Total Amount:</strong>
                            {{ item.totalAmount }} {{ getUnitLabel(item.unit) }}
                          </p>
                        </div>
                  
                        <!-- Display Combined Processing Breakdowns -->
                        <p><strong>Processing Breakdown:</strong></p>
                        <ul>
                          <li *ngFor="let item of getProcessingBreakdown(getCombinedProcessingBreakdown(ingredientName))">
                            {{ item.label }}: {{ item.amount }} {{ getUnitLabel(item.unit) }}
                          </li>
                        </ul>
                  
                        <!-- Button to Open Offers Dialog -->
                        <button
                        pButton
                        label="Select Offers"
                        (click)="openOfferSelectionDialog(ingredientName)"
                        [disabled]="!hasOffersForIngredient(ingredientName)"
                      >
                      </button>
                      </p-accordionTab>
                    </ng-container>
                  </p-accordion>
                  
            </p-card>
        </div>

            <div class="rbm-flex-column rbm-padding-m">
                Anzeige
                <div *ngFor="let item of ingredientOfferMapping">
                    <ng-container *ngFor="let ingredient of item.ingredient">
                    <p *ngIf="item.status === 'OFFERS_FOUND' && item.selected" class="valid-offer">{{ ingredient?.name }}</p>
                    <p *ngIf="item.status === 'OFFERS_FOUND' && !item.selected" class="unselected-offer">{{ ingredient?.name }}</p>
                    <p *ngIf="item.status === 'NO_OFFERS'" class="invalid-offer">{{ ingredient?.name }}</p>
                </ng-container>
                    <ng-container *ngFor="let offerItem of item.offers">
                        <p *ngIf="offerItem.selected">SELECTED: {{ offerItem.offer.offerDetails.id }}</p>

                    </ng-container>
                </div>
                <p *ngIf="hasOrdersRunning"> Es gibt bereits mind. eine laufende bestellung</p>
                <button *ngIf="hasOrdersRunning" (click)="openshowOfferSelectionDialog()">Zeigen</button>
                <button (click)="createSummary()">
                    {{ getButtonLabel() }}
                  </button>
            </div>
        </div>
    </div>

</div>
<p-toast></p-toast>

<p-dialog
  header="Angebot auswählen"
  [(visible)]="showRunningOrdersDialog"
  modal="modal"
  [closable]="false"
>
  <p>Bitte wählen Sie ein Angebot aus der Liste unten aus:</p>
  <ul>
    <li *ngFor="let offer of offerDataList">
      <!-- Customize the display as needed -->
      <button (click)="navigateToOffer(offer.id)">
        Angebot ID: {{ offer.id }}
      </button>
    </li>
  </ul>
  <p-footer>
    <button
      type="button"
      pButton
      label="Schließen"
      (click)="showRunningOrdersDialog = false"
    ></button>
  </p-footer>
</p-dialog>

<p-dialog
  header="Angebote auswählen"
  [(visible)]="showOfferSelectionDialog"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '50vw' }"
>
  <!-- Display the Ingredient and Total Amount -->
  <p>
    <strong>Sie suchen nach:</strong> {{ getLocalizedLabel(selectedIngredientName) }},
    insgesamt
    <ng-container *ngFor="let item of getTotalAmountsPerUnitArray(selectedIngredientName); let i = index">
      {{ item.totalAmount }} {{ getUnitLabel(item.unit) }}<span *ngIf="i < getTotalAmountsPerUnitArray(selectedIngredientName).length - 1">, </span>
    </ng-container>
    .
  </p>

  <!-- Expandable Processing Breakdown -->
  <p-accordion>
    <p-accordionTab header="Aufschlüsselung">
      <ul>
        <li
          *ngFor="let item of getProcessingBreakdown(getCombinedProcessingBreakdown(selectedIngredientName))"
        >
          {{ item.label }}: {{ item.amount }} {{ getUnitLabel(item.unit) }}
        </li>
      </ul>
    </p-accordionTab>
  </p-accordion>

  <!-- Existing Offer Selection Content -->
  <p *ngIf="selectedIngredientOffers.length > 0">Verfügbare Angebote:</p>
  <p *ngIf="selectedIngredientOffers.length === 0">Keine Angebote für diese Zutat verfügbar.</p>

  <div *ngIf="selectedIngredientOffers.length > 0">
    <div *ngFor="let offerItem of selectedIngredientOffers">
      <div class="p-field-checkbox">
        <p-checkbox
          [(ngModel)]="offerItem.selected"
          (ngModelChange)="onOfferSelectionChange()"
          [binary]="true"
          inputId="{{ 'offer_' + offerItem.offer.offerDetails.id }}"
        ></p-checkbox>
        <label for="{{ 'offer_' + offerItem.offer.offerDetails.id }}">
          <h5>{{ offerItem.offer?.company?.name }}</h5>
          <p>
            <strong>Produktname:</strong>
            {{ offerItem.offer?.offerDetails?.productTitle }}
          </p>
          <p>
            <strong>Preis pro Einheit:</strong>
            €{{ offerItem.offer?.offerDetails?.pricePerUnit }}
          </p>
        </label>
      </div>
      <hr />
    </div>
  </div>

  <p-footer>
    <button
      type="button"
      pButton
      label="Schließen"
      (click)="closeOfferSelectionDialog()"
    ></button>
  </p-footer>
</p-dialog>