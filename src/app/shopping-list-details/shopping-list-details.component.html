<div class="shopping-list-details p-m-3 p-shadow-3 p-p-4">
    <h1>Shopping List and Offers</h1>

    <div class="actions">
        <button pButton label="Clear Cache & Reload Offers" (click)="clearCacheAndReload()"></button>
    </div>
    
    <p-progressSpinner *ngIf="loading"></p-progressSpinner>
    <p-confirmDialog></p-confirmDialog>

    <p-slider [(ngModel)]="range" [min]="0" [max]="250" [step]="1"></p-slider>
    <p>Selected Range: {{ range }} km</p>
    
    <div *ngIf="!loading && shoppingList" class="p-grid">
        <div class="rbm-flex-row">
        <div class="p-col-6">
            <p-card header="{{ shoppingList?.name }}"
                subheader="Date Created: {{ shoppingList?.createdAt | date:'shortDate' }}">
                <h3>Ingredients</h3>
                <p-accordion>
                    <ng-container *ngFor="let ingredientName of ingredientNames">
                        <p-accordionTab header="{{ getLocalizedLabel(ingredientName) }}">
                            <ng-container *ngFor="let ingredient of shoppingList?.groupedShoppingList[ingredientName]">
                                <p-panel header="{{ getLocalizedLabel(ingredient?.name) }}">
                                    <p><strong>Total Amount:</strong> {{ ingredient?.totalAmount }} {{
                                        getUnitLabel(ingredient?.unit) }}</p>
                                    <p><strong>Category:</strong> {{ ingredient?.category }}</p>
                                    <p><strong>Convertible:</strong> {{ ingredient?.convertible ? 'Yes' : 'No' }}</p>
                                    <p><strong>Source Recipes:</strong> {{ ingredient?.sourceRecipes?.join(', ') }}</p>
                                    <p><strong>Processing:</strong></p>
                                    <ul>
                                        <li
                                            *ngFor="let processing of getProcessingBreakdown(ingredient?.processingBreakdown)">
                                            {{ processing.label }}: {{ processing.amount }}
                                        </li>
                                    </ul>
                                    <!-- Matching Offers Section -->
                                    <p-accordion>
                                        <p-accordionTab header="Matching Offers">
                                            <ng-container *ngFor="let item of ingredientOfferMapping">
                                                <ng-container *ngFor="let offerItem of item.offers">
                                                    <ng-container *ngIf="matchOfferToIngredient(ingredient.name, offerItem.offer)">
                                                    <h5>{{ offerItem.offer?.company?.name }}</h5>
                                                    <p><strong>Product Title:</strong> {{
                                                        offerItem?.offer?.offerDetails?.productTitle }}</p>
                                                    <p><strong>Price per Unit:</strong> €{{
                                                        offerItem?.offer?.offerDetails?.pricePerUnit }}</p>
                                                    <p>{{ offerItem?.offer?.offerDetails?.id }}</p>
                                                 
                                                    <p-checkbox 
                                                    [(ngModel)]="offerItem.selected" 
                                                    [binary]="true" 
                                                    inputId="binary" 
                                                    (onChange)="toggleOfferSelection(item.ingredient, offerItem.offer.offerDetails.id, $event.checked)">
                                                  </p-checkbox>
                                                    </ng-container>
                                                </ng-container>
                                            </ng-container>
                                        </p-accordionTab>
                                    </p-accordion>
                                </p-panel>
                            </ng-container>
                        </p-accordionTab>
                    </ng-container>
                </p-accordion>
            </p-card>
        </div>

            <div class="rbm-flex-column rbm-padding-m">
                Anzeige
                <div *ngFor="let item of ingredientOfferMapping">
                    <ng-container *ngFor="let ingredient of item.ingredient">
                    <p *ngIf="item.status === 'OFFERS_FOUND' && item.selected" class="valid-offer">{{ ingredient?.name }}</p>
                    <p *ngIf="item.status === 'OFFERS_FOUND' && !item.selected" class="unselected-offer">{{ ingredient?.name }}</p>
                    <p *ngIf="item.status === 'NO_OFFERS'" class="invalid-offer">{{ ingredient?.name }}</p>
                </ng-container>
                    <ng-container *ngFor="let offerItem of item.offers">
                        <p *ngIf="offerItem.selected">SELECTED: {{ offerItem.offer.offerDetails.id }}</p>

                    </ng-container>
                </div>
                <p *ngIf="hasOrdersRunning"> Es gibt bereits mind. eine laufende bestellung</p>
                <button *ngIf="hasOrdersRunning" (click)="openshowOfferSelectionDialog()">Zeigen</button>
                <button (click)="createSummary()">
                    {{ getButtonLabel() }}
                  </button>
            </div>
        </div>
    </div>

</div>
<p-toast></p-toast>

<p-dialog
  header="Angebot auswählen"
  [(visible)]="showOfferSelectionDialog"
  modal="modal"
  [closable]="false"
>
  <p>Bitte wählen Sie ein Angebot aus der Liste unten aus:</p>
  <ul>
    <li *ngFor="let offer of offerDataList">
      <!-- Customize the display as needed -->
      <button (click)="navigateToOffer(offer.id)">
        Angebot ID: {{ offer.id }}
      </button>
    </li>
  </ul>
  <p-footer>
    <button
      type="button"
      pButton
      label="Schließen"
      (click)="showOfferSelectionDialog = false"
    ></button>
  </p-footer>
</p-dialog>